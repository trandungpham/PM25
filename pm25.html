<!DOCTYPE html>
<html>
<head>
  <title>PM2.5 AQI 3D Viewer</title>
  <script src="https://cdn.plot.ly/plotly-3.0.3.min.js" charset="utf-8"></script>

  <style>
    #controls {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      margin: 0;           /* reduce vertical space */
      background-color: #f2efef;
    }
    /* Navbar Style */
    nav {
      background-color: #333;
      padding: 1em;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    nav ul li a:hover {
      text-decoration: underline;
    }

    /* Popup Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(3px);
    }

    .modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 5% auto;
      padding: 0;
      border: none;
      border-radius: 15px;
      width: 80%;
      max-width: 900px;
      height: 70%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease-out;
      position: relative;
      overflow: hidden;
    }

    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      background: rgba(255,255,255,0.95);
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .modal-title {
      margin: 0;
      color: #333;
      font-size: 1.5em;
      font-weight: 600;
    }

    .close {
      color: #999;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
      background: none;
      border: none;
    }

    .close:hover {
      color: #555;
    }

    .modal-body {
      background: rgba(255,255,255,0.98);
      height: calc(100% - 60px);
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    #lineChart {
      width: 100%;
      flex: 1;
      min-height: 400px;
    }

    .coordinate-info {
      background: rgba(102, 126, 234, 0.1);
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      flex-shrink: 0;
    }

    .chart-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
      background: rgba(240, 248, 255, 0.8);
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .control-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 4px 12px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
    }

    .control-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
    }

    .control-btn.active {
      background: linear-gradient(135deg, #28a745, #20c997);
    }

    .data-range-slider {
      width: 100px;
      margin: 0 5px;
    }

    .time-input {
      border: 1px solid #ddd;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      width: 50px;
    }

    .aggregation-select {
      border: 1px solid #ddd;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    .fullscreen-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      border: none;
      padding: 4px 12px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(255, 107, 107, 0.2);
    }

    .fullscreen-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(255, 107, 107, 0.3);
    }

    .modal-content.fullscreen {
      margin: 0;
      width: 100vw;
      height: 100vh;
      max-width: none;
      border-radius: 0;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1001;
    }

    .modal-content.fullscreen .modal-body {
      height: calc(100vh - 60px);
      padding: 20px;
    }

    .modal-content.fullscreen #lineChart {
      min-height: calc(100vh - 200px);
    }

  </style>
</head>
<body>
    <nav>
        <ul>
        <li><a href="pm25.html">PM2.5</a></li>
        <li><a href="pm10.html">PM10</a></li>
        <li><a href="CO.html">CO</a></li>
        </ul>
    </nav>
    <h2>PM2.5 AQI Viewer</h2>
    <div style="display: flex;">
        <div id="plot3d" style="width: 50%; height: 630px;"></div>
        <div id="plot2d" style="width: 50%; height: 630px;"></div>
    </div>
    <div id="controls">
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
        <button id="speedBtn">Speed: 1x</button>
        <input type="range" id="slider" min="0" max="N-1" value="0" step="1">
    </div>

    <!-- Modal for Line Chart -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">PM2.5 AQI Time Series</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="fullscreen-btn" onclick="toggleFullscreen()" id="fullscreenBtn">⛶ Fullscreen</button>
                    <button class="close" onclick="closeModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="coordinate-info" id="coordinateInfo"></div>
                <div id="lineChart"></div>
            </div>
        </div>
    </div>

  <script>
    let X, Y, timestamps = [];
    let intervalId = null;
    let currentFrame = 0;
    let speed = 500; // default = 1x speed (500 ms)
    let isFast = false;
    let allFrameData = {}; // Store all frame data for time series
    let customColor = [
            [0, '#ffffff'],   // No Data
            [1 / 6, '#00A651'],  // Good
            [2 / 6, '#FFC627'],  // Moderate
            [3 / 6, '#F58220'],  // Unhealthy for Sensitive
            [4 / 6, '#ED1C24'],  // Unhealthy
            [5 / 6, '#662D91'],  // Very Unhealthy
            [1, '#4A0A38']       // Hazardous
        ];
    const speedBtn = document.getElementById("speedBtn");
    const slider = document.getElementById("slider");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    // Modal functions
    function openModal() {
        document.getElementById('chartModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('chartModal').style.display = 'none';
        // Exit fullscreen if active
        const modalContent = document.querySelector('.modal-content');
        if (modalContent.classList.contains('fullscreen')) {
            modalContent.classList.remove('fullscreen');
            document.getElementById('fullscreenBtn').innerHTML = '⛶ Fullscreen';
        }
    }

    // Fullscreen functionality
    let isFullscreen = false;

    function toggleFullscreen() {
        const modalContent = document.querySelector('.modal-content');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        
        isFullscreen = !isFullscreen;
        
        if (isFullscreen) {
            modalContent.classList.add('fullscreen');
            fullscreenBtn.innerHTML = '⛶ Exit Fullscreen';
            
            // Resize chart after fullscreen transition
            setTimeout(() => {
                Plotly.Plots.resize('lineChart');
            }, 300);
        } else {
            modalContent.classList.remove('fullscreen');
            fullscreenBtn.innerHTML = '⛶ Fullscreen';
            
            // Resize chart after exiting fullscreen
            setTimeout(() => {
                Plotly.Plots.resize('lineChart');
            }, 300);
        }
    }

    // Handle ESC key to exit fullscreen
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && isFullscreen) {
            toggleFullscreen();
        }
    });

    // Chart optimization variables
    let originalTimeSeriesData = [];
    let originalTimeLabels = [];
    let currentDisplayData = [];
    let currentDisplayLabels = [];

    function updateChart() {
        const trace = {
            x: currentDisplayLabels,
            y: currentDisplayData,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'PM2.5 AQI',
            line: {
                color: '#667eea',
                width: 2
            },
            marker: {
                color: currentDisplayData.map(val => {
                    if (val <= 1) return '#00A651';
                    else if (val <= 2) return '#FFC627';
                    else if (val <= 3) return '#F58220';
                    else if (val <= 4) return '#ED1C24';
                    else if (val <= 5) return '#662D91';
                    else return '#4A0A38';
                }),
                size: currentDisplayData.length > 100 ? 4 : 6,
                line: { color: '#fff', width: 1 }
            },
            hovertemplate: '<b>%{x}</b><br>AQI: %{y:.2f}<br><extra></extra>'
        };

        const layout = {
            title: {
                text: `PM2.5 AQI Time Series (${currentDisplayData.length} points displayed)`,
                font: { size: 16, color: '#333' }
            },
            xaxis: {
                title: 'Time',
                tickangle: -45,
                gridcolor: '#e0e0e0'
            },
            yaxis: {
                title: 'AQI Level',
                range: [0, Math.max(6, Math.max(...currentDisplayData) * 1.1)],
                gridcolor: '#e0e0e0'
            },
            plot_bgcolor: '#fafafa',
            paper_bgcolor: 'transparent',
            margin: { l: 50, r: 30, t: 50, b: 80 },
            hovermode: 'closest',
            showlegend: false
        };

        // Add background shapes for AQI levels
        if (currentDisplayData.length > 0 && currentDisplayLabels.length > 0) {
            layout.shapes = [
                {type: 'rect', x0: currentDisplayLabels[0], x1: currentDisplayLabels[currentDisplayLabels.length-1], y0: 0, y1: 12, fillcolor: '#00A651', opacity: 0.1, line: {width: 0}},
                {type: 'rect', x0: currentDisplayLabels[0], x1: currentDisplayLabels[currentDisplayLabels.length-1], y0: 12, y1: 35, fillcolor: '#FFC627', opacity: 0.1, line: {width: 0}},
                {type: 'rect', x0: currentDisplayLabels[0], x1: currentDisplayLabels[currentDisplayLabels.length-1], y0: 35, y1: 55, fillcolor: '#F58220', opacity: 0.1, line: {width: 0}},
                {type: 'rect', x0: currentDisplayLabels[0], x1: currentDisplayLabels[currentDisplayLabels.length-1], y0: 55, y1: 150, fillcolor: '#ED1C24', opacity: 0.1, line: {width: 0}},
                {type: 'rect', x0: currentDisplayLabels[0], x1: currentDisplayLabels[currentDisplayLabels.length-1], y0: 150, y1: 250, fillcolor: '#662D91', opacity: 0.1, line: {width: 0}},
                {type: 'rect', x0: currentDisplayLabels[0], x1: currentDisplayLabels[currentDisplayLabels.length-1], y0: 250, y1: 700, fillcolor: '#4A0A38', opacity: 0.1, line: {width: 0}}
            ];
        }

        Plotly.newPlot('lineChart', [trace], layout, {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            scrollZoom: true,
            doubleClick: 'reset',
            showTips: true
        }).then(() => {
            // Ensure chart resizes properly in fullscreen
            if (isFullscreen) {
                setTimeout(() => {
                    Plotly.Plots.resize('lineChart');
                }, 100);
            }
        });
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('chartModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // Function to get AQI category name
    function getAQICategory(value) {
        if (value <= 11) return "Good";
        else if (value <= 34) return "Moderate";
        else if (value <= 54) return "Unhealthy for Sensitive";
        else if (value <= 149) return "Unhealthy";
        else if (value <= 249) return "Very Unhealthy";
        else return "Hazardous";
    }

    // Function to create time series chart for a specific coordinate
    async function createTimeSeriesChart(xCoord, yCoord, xIndex, yIndex) {
        const timeSeriesData = [];
        const timeLabels = [];

        const sliceTimestamps = timestamps.slice(0, currentFrame + 1);

        const loadFrameValue = async (timestamp) => {
            try {
                // Load from cache if available
                let frameData;
                if (allFrameData[timestamp]) {
                    frameData = allFrameData[timestamp];
                } else {
                    const res = await fetch(`Frames/PM25_1/${timestamp}.json`);
                    if (!res.ok) throw new Error(`Failed to load frame ${timestamp}`);
                    frameData = await res.json();
                    allFrameData[timestamp] = frameData; // Cache it
                }

                const value = frameData[yIndex]?.[xIndex];
                if (value !== null && !isNaN(value)) {
                    timeSeriesData.push(value);
                    timeLabels.push(timestamp);
                }
            } catch (err) {
                console.warn(`Skipping frame ${timestamp} due to error:`, err.message);
            }
        };

        // Load all values sequentially (you can optimize to parallel if needed)
        for (const timestamp of sliceTimestamps) {
            await loadFrameValue(timestamp);
        }

        if (timeSeriesData.length === 0) {
            alert('No data available for this location.');
            return;
        }

        const minAQI = Math.min(...timeSeriesData);
        const maxAQI = Math.max(...timeSeriesData);
        const avgAQI = timeSeriesData.reduce((a, b) => a + b, 0) / timeSeriesData.length;

        document.getElementById('coordinateInfo').innerHTML = `
            <strong>Location:</strong> Longitude ${xCoord.toFixed(4)}, Latitude ${yCoord.toFixed(4)}<br>
            <strong>Current AQI:</strong> ${timeSeriesData[timeSeriesData.length - 1]?.toFixed(2) || 'N/A'} (${getAQICategory(timeSeriesData[timeSeriesData.length - 1] || 0)})<br>
            <strong>Data Points:</strong> ${timeSeriesData.length}<br>
            <strong>AQI Range:</strong> ${minAQI.toFixed(2)} - ${maxAQI.toFixed(2)} (avg: ${avgAQI.toFixed(2)})
        `;

        originalTimeSeriesData = [...timeSeriesData];
        originalTimeLabels = [...timeLabels];
        currentDisplayData = [...timeSeriesData];
        currentDisplayLabels = [...timeLabels];

        updateChart();
    }



    // Load coordinate grids
    Promise.all([
        fetch('Frames/PM25_1/xu.json').then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            return r.json();
        }).catch(err => {
            console.error('Error loading xu.json:', err);
            console.log('Using default X coordinates');
            // Generate default coordinate grid if file missing
            const defaultX = [];
            for (let i = 0; i < 50; i++) {
            defaultX.push(126.0 + (i * 0.01)); // Approximate longitude range for Korea
            }
            return defaultX;
        }),
        fetch('Frames/PM25_1/yu.json').then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            return r.json();
        }).catch(err => {
            console.error('Error loading yu.json:', err);
            console.log('Using default Y coordinates');
            // Generate default coordinate grid if file missing
            const defaultY = [];
            for (let i = 0; i < 49; i++) {
            defaultY.push(33.0 + (i * 0.01)); // Approximate latitude range for Korea
            }
            return defaultY;
        })
    ]).then(([xu, yu]) => {
      console.log('Loaded coordinates - X:', xu.length, 'Y:', yu.length);
      X = xu;
      Y = yu;

        // Generate meshgrid
        const mesh = (a, b) => {
            const x = [], y = [];
            for (let i = 0; i < b.length; i++) {
            x.push(a);
            y.push(Array(a.length).fill(b[i]));
            }
            return [x, y];
        };
        const [xmesh, ymesh] = mesh(xu, yu);

        function categorizePM25(Zraw) {
            return Zraw.map(row => row.map(val => {
                if (val === 0) return 0;              // No Data
                else if (val <= 11) return 1;                          // Good
                else if (val <= 34) return 2;                          // Moderate
                else if (val <= 54) return 3;                          // Unhealthy for Sensitive
                else if (val <= 149) return 4;                         // Unhealthy
                else if (val <= 249) return 5;                         // Very Unhealthy
                else return 6;                                         // Hazardous
            }));
        }

        // Load all frame file names
        fetch('Frames/PM25_1/index.json')
            .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            return r.json();
            })
            .then(index => {
            console.log('Loaded index:', index?.length || 0, 'frames');
            
            // If index is empty, generate file list from known pattern
            if (!index || index.length === 0) {
                console.log('Index.json is empty, generating file list from directory pattern...');
                timestamps = generateTimestampList();
            } else {
                timestamps = index;
            }
            
            slider.max = timestamps.length - 1;
            console.log('Total timestamps:', timestamps.length);
            
            // Load all frame data
            loadFrame(0);
            })
            .catch(err => {
            console.error('Error loading index.json:', err);
            console.log('Falling back to generated timestamp list...');
            
            // Generate timestamps based on file pattern
            timestamps = generateTimestampList();
            slider.max = timestamps.length - 1;
            console.log('Using fallback timestamps:', timestamps.length, 'total');
            
            // Load all frame data
            loadFrame(0);
        });

        function loadFrame(i) {
            if (i < 0 || i >= timestamps.length) {
                console.error('Frame index out of range:', i);
                return;
            }

            const timestamp = timestamps[i];
            currentFrame = i;
            slider.value = i;

            // Check if already cached
            if (allFrameData[timestamp]) {
                renderFrame(timestamps[i], allFrameData[timestamp]);
            } else {
                fetch(`Frames/PM25_1/${timestamp}.json`)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                        return r.json();
                    })
                    .then(data => {
                        allFrameData[timestamp] = data; // optional caching
                        renderFrame(timestamp, data);
                    })
                    .catch(err => {
                        console.error(`Failed to load frame: ${timestamp}`, err);
                        alert(`Failed to load frame: ${timestamp}`);
                    });
            }
        }

        function renderFrame(timestamp, rawZ) {
            const Z = categorizePM25(rawZ);
            const i = timestamps.indexOf(timestamp);

            // 3D plot
            Plotly.newPlot("plot3d", [{
                type: 'surface',
                x: xmesh,
                y: ymesh,
                z: Z,
                colorscale: customColor,
                cmin: 0, cmax: 6,
                showscale: false
            }], {
                title: { text: `3D - ${timestamp}` },
                scene: {
                    zaxis: { title: { text: 'AQI' }, range: [0, 6] },
                    xaxis: {}, yaxis: {},
                    camera: { eye: { x: -1.6, y: -1.6, z: 0.8 } }
                }
            }, {
                staticPlot: false,
                displayModeBar: false
            }).then(() => {
                document.getElementById('plot3d').on('plotly_click', function(data) {
                    if (data.points && data.points.length > 0) {
                        const point = data.points[0];
                        const xCoord = point.x;
                        const yCoord = point.y;
                        const xIndex = X.reduce((closest, curr, idx) =>
                            Math.abs(curr - xCoord) < Math.abs(X[closest] - xCoord) ? idx : closest, 0);
                        const yIndex = Y.reduce((closest, curr, idx) =>
                            Math.abs(curr - yCoord) < Math.abs(Y[closest] - yCoord) ? idx : closest, 0);
                        createTimeSeriesChart(xCoord, yCoord, xIndex, yIndex);
                        openModal();
                    }
                });
            });

            // 2D plot
            Plotly.newPlot("plot2d", [{
                type: 'heatmap',
                z: Z,
                x: X,
                y: Y,
                colorscale: customColor,
                zmin: 0, zmax: 6,
                showscale: true,
                colorbar: {
                    tickvals: [0, 1, 2, 3, 4, 5, 6],
                    ticktext: [
                        "0", "1 - Good (0-11)", "2 - Moderate (12–34)",
                        "3 - Unhealthy for Sensitive (35–54)", "4 - Unhealthy (55–149)",
                        "5 - Very Unhealthy (150–249)", "6 - Hazardous (250+)"
                    ],
                    title: { text: "AQI Category (µg/m³)" }
                }
            }], {
                title: { text: `2D Heatmap - ${timestamp}` },
                xaxis: { title: '' },
                yaxis: { title: '' }
            }).then(() => {
                document.getElementById('plot2d').on('plotly_click', function(data) {
                    if (data.points && data.points.length > 0) {
                        const point = data.points[0];
                        const xIndex = point.pointNumber[1];
                        const yIndex = point.pointNumber[0];
                        const xCoord = X[xIndex];
                        const yCoord = Y[yIndex];
                        createTimeSeriesChart(xCoord, yCoord, xIndex, yIndex);
                        openModal();
                    }
                });
            });
        }
        slider.addEventListener("input", () => {
        loadFrame(parseInt(slider.value));
    });

    speedBtn.addEventListener("click", () => {
    isFast = !isFast;
    speed = isFast ? 250 : 500;  // 2x speed is 250ms
    speedBtn.innerText = `Speed: ${isFast ? "2x" : "1x"}`;

    // Restart animation with new speed if it's running
    if (intervalId !== null) {
        clearInterval(intervalId);
        intervalId = setInterval(() => {
        currentFrame = (currentFrame + 1) % timestamps.length;
        loadFrame(currentFrame);
        }, speed);
    }
    });


    startBtn.addEventListener("click", () => {
      if (intervalId === null) {
      intervalId = setInterval(() => {
          currentFrame = (currentFrame + 1) % timestamps.length;
          loadFrame(currentFrame);
      }, speed);}
    });

    stopBtn.addEventListener("click", () => {
        clearInterval(intervalId);
        intervalId = null;
    });

    });
    
  </script>
</body>
</html>