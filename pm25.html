<!DOCTYPE html>
<html>
<head>
  <title>PM2.5 AQI 3D Viewer</title>
  <script src="https://cdn.plot.ly/plotly-3.0.3.min.js" charset="utf-8"></script>

  <style>
    #controls {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      margin: 0;           /* reduce vertical space */
      background-color: #f2efef;
    }
    /* Navbar Style */
    nav {
      background-color: #333;
      padding: 1em;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    nav ul li a:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>
    <nav>
        <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="pm25.html">PM2.5</a></li>
        <li><a href="pm10.html">PM10</a></li>
        <li><a href="CO.html">CO</a></li>
        </ul>
    </nav>
    <h2>PM2.5 AQI Viewer</h2>
    <div style="display: flex;">
        <div id="plot3d" style="width: 50%; height: 630px;"></div>
        <div id="plot2d" style="width: 50%; height: 630px;"></div>
    </div>
    <div id="lineplot" style="width: 100%; height: 400px;"></div>
    <div id="controls">
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
        <button id="speedBtn">Speed: 1x</button>
        <button id="linechart"> Load Line chart</button>
        <input type="range" id="slider" min="0" max="N-1" value="0" step="1">
    </div>

  <script>
    let X, Y, timestamps = [];
    let intervalId = null;
    let currentFrame = 0;
    let speed = 500; // default = 1x speed (500 ms)
    let isFast = false;
    let customColor = [
            [0, '#ffffff'],   // No Data
            [1 / 6, '#00A651'],  // Good
            [2 / 6, '#FFC627'],  // Moderate
            [3 / 6, '#F58220'],  // Unhealthy for Sensitive
            [4 / 6, '#ED1C24'],  // Unhealthy
            [5 / 6, '#662D91'],  // Very Unhealthy
            [1, '#4A0A38']       // Hazardous
        ];
    const speedBtn = document.getElementById("speedBtn");
    const slider = document.getElementById("slider");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const LineChart = document.getElementById("linechart")

    // Load coordinate grids
    Promise.all([
      fetch('Frames/PM25_1/xu.json').then(r => r.json()),
      fetch('Frames/PM25_1/yu.json').then(r => r.json())
    ]).then(([xu, yu]) => {
      X = xu;
      Y = yu;

      // Generate meshgrid
      const mesh = (a, b) => {
        const x = [], y = [];
        for (let i = 0; i < b.length; i++) {
          x.push(a);
          y.push(Array(a.length).fill(b[i]));
        }
        return [x, y];
      };
      const [xmesh, ymesh] = mesh(xu, yu);

      // Load all frame file names
      fetch('Frames/PM25_1/index.json')
        .then(r => r.json())
        .then(index => {
          timestamps = index;
          slider.max = timestamps.length - 1;
          loadFrame(0);
        });
        function categorizePM25(Zraw) {
        return Zraw.map(row => row.map(val => {
            if (val === 0) return 0;              // No Data
            else if (val <= 11) return 1;                          // Good
            else if (val <= 34) return 2;                          // Moderate
            else if (val <= 54) return 3;                          // Unhealthy for Sensitive
            else if (val <= 149) return 4;                         // Unhealthy
            else if (val <= 249) return 5;                         // Very Unhealthy
            else return 6;                                         // Hazardous
        }));
        }
      // Render a frame
    function loadFrame(i) {
  const timestamp = timestamps[i];
  fetch(`Frames/PM25_1/${timestamp}.json`)
    .then(r => r.json())
    .then(Zraw => {
        const Z = categorizePM25(Zraw);
      // 3D plot
      Plotly.newPlot("plot3d", [{
        type: 'surface',
        x: xmesh,
        y: ymesh,
        z: Z,
        colorscale: customColor,
        cmin: 0, cmax: 6,
        showscale: false
      }], {
        title: {text: `3D - ${timestamp}`},
        scene: {
          zaxis: {
            title: { text: 'AQI' },
            range: [0, 6]
          },
          xaxis: {},
          yaxis: {},
          camera: {
            eye: { x: -1.6, y: -1.6, z: 0.8 }
          }
        }
      });

      // 2D plot
      Plotly.newPlot("plot2d", [{
        type: 'heatmap',
        z: Z,
        x: X,
        y: Y,
        colorscale: customColor,
        zmin: 0, zmax: 6,
        showscale: true,
        colorbar: {
          tickvals: [0, 1, 2, 3, 4, 5, 6],
          ticktext: [
            "0", "1 - Good (0-11)", "2 - Moderate (12-34)", "3 - Unhealthy for Sensitive (35-54)",
            "4 - Unhealthy (55-150)", "5 - Very Unhealthy (150-249)", "6 - Hazardous (>250)"
          ],
          title: {text: "AQI Category (µg/m³)"},
        }
      }], {
        title: { text: `2D Heatmap - ${timestamp}`},
        xaxis: { title: ''},
        yaxis: { title: ''}
      });
    })
    .catch(err => {
      console.error("Error loading frame:", err);
    });

    let selectedXIdx = null;
    let selectedYIdx = null;

    let xi = 540.5;
    let yi = 3923.5;

    // New: capture click event from 2D plot
    document.getElementById('plot2d').on('plotly_click', function(data) {
        if (data.points.length > 0) {
            const pt = data.points[0];
            const xval = pt.x;
            const yval = pt.y;

            selectedXIdx = X.indexOf(xval);
            selectedYIdx = Y.indexOf(yval);
            console.log("Clicked at", selectedXIdx, selectedYIdx);

            if (selectedXIdx !== -1 && selectedYIdx !== -1) {
                loadLineChart(selectedXIdx, selectedYIdx);
            }
        }
    });

    // Function to load and render line chart at selected point
    function loadLineChart(xi, yi) {
        const valuesOverTime = [];

        let fetches = timestamps.map(ts =>
            fetch(`Frames/PM25_1/${ts}.json`)
                .then(r => r.json())
                .then(Z => valuesOverTime.push(Z[yi][xi]))
        );

        Promise.all(fetches).then(() => {
            Plotly.newPlot("lineplot", [{
                x: timestamps,
                y: valuesOverTime,
                mode: 'lines+markers',
                line: { color: '#ED1C24' },
                marker: { size: 4 },
                name: `PM2.5 at (x=${X[xi]}, y=${Y[yi]})`
            }], {
                title: `Time Series of PM2.5 at Selected Point`,
                xaxis: { title: "Timestamp" },
                yaxis: { title: "AQI Level", range: [0, 6] }
            });
        });
    }



    }

    LineChart.addEventListener("click",  () => {
        loadLineChart(540.5, 3923.5);
    });


    slider.addEventListener("input", () => {
    loadFrame(parseInt(slider.value));
    });

    speedBtn.addEventListener("click", () => {
    isFast = !isFast;
    speed = isFast ? 250 : 500;  // 2x speed is 250ms
    speedBtn.innerText = `Speed: ${isFast ? "2x" : "1x"}`;

    // Restart animation with new speed if it's running
    if (intervalId !== null) {
        clearInterval(intervalId);
        intervalId = setInterval(() => {
        currentFrame = (currentFrame + 1) % timestamps.length;
        loadFrame(currentFrame);
        }, speed);
    }
    });


        startBtn.addEventListener("click", () => {
    if (intervalId === null) {
    intervalId = setInterval(() => {
        currentFrame = (currentFrame + 1) % timestamps.length;
        loadFrame(currentFrame);
    }, speed);}
    });

    stopBtn.addEventListener("click", () => {
        clearInterval(intervalId);
        intervalId = null;
    });



    });

    
  </script>
</body>
</html>
