<!DOCTYPE html>
<html>
<head>
  <title>PM2.5 AQI 3D Viewer</title>
  <script src="https://cdn.plot.ly/plotly-3.0.3.min.js" charset="utf-8"></script>

  <style>
    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
      padding: 10px;
      height: calc(100vh - 150px); /* Adjust based on navbar and controls height */
    }

    .grid-item {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    /* Bottom row with 2:8 ratio */
    .bottom-row-container {
      display: grid;
      grid-template-columns: 4fr 6fr; /* 2:8 ratio */
      gap: 10px;
      grid-column: 1 / -1; /* Span entire row */
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    .bottom-row-item {
      width: 100%;
      height: 100%;
    }

    #controls {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      margin: 0;
      background-color: #f2efef;
      border-bottom: 1px solid #ccc;
    }

    /* Navbar Style */
    nav {
      background-color: #333;
      padding: 1em;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    nav ul li a:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>
    <nav>
        <ul>
        <li><a href="pm25.html">PM2.5</a></li>
        <li><a href="pm10.html">PM10</a></li>
        <li><a href="CO.html">CO</a></li>
        </ul>
    </nav>
    <h2>PM2.5 AQI Viewer</h2>
    <div id="controls">
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
        <button id="speedBtn">Speed: 1x</button>
        <input type="range" id="slider" min="0" max="N-1" value="0" step="1">
        <span style="margin-left: 10px; font-size: 12px;">Frame: <span id="frameCounter">0</span></span>
    </div>
    <div class="grid-container">
        <!-- Top row: 3D plot and Interactive Map -->
        <div id="plot3d" class="grid-item"></div>
        <div id="map2d" class="grid-item"></div>
        
        <!-- Bottom row: Static Map (20%) and Time Series (80%) -->
        <div class="bottom-row-container">
            <div id="staticmap" class="bottom-row-item"></div>
            <div id="lineplot" class="bottom-row-item"></div>
        </div>
    </div>

  <script>
    let X, Y, timestamps = [];
    let intervalId = null;
    let currentFrame = 0;
    let speed = 500; // default = 1x speed (500 ms)
    let isFast = false;
    
    // Default location coordinates
    const DEFAULT_X = 540.5;
    const DEFAULT_Y = 3923.5;
    
    // Helper to find the nearest index in a coordinate array
    function findNearestIndex(val, arr) {
        let nearest = 0;
        let minDiff = Math.abs(val - arr[0]);
        for (let i = 1; i < arr.length; i++) {
            const diff = Math.abs(val - arr[i]);
            if (diff < minDiff) {
                minDiff = diff;
                nearest = i;
            }
        }
        return nearest;
    }
    
    let selectedXIdx = null;
    let selectedYIdx = null;
    
    let customColor = [
            [0, '#ffffff'],   // No Data
            [1 / 6, '#00A651'],  // Good
            [2 / 6, '#FFC627'],  // Moderate
            [3 / 6, '#F58220'],  // Unhealthy for Sensitive
            [4 / 6, '#ED1C24'],  // Unhealthy
            [5 / 6, '#662D91'],  // Very Unhealthy
            [1, '#4A0A38']       // Hazardous
        ];
    const speedBtn = document.getElementById("speedBtn");
    const slider = document.getElementById("slider");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    // Function to load and render line chart at selected point
    function loadLineChart(xi, yi) {
        console.log("loadLineChart called with indices:", xi, yi);
        console.log("Coordinates:", X ? X[xi] : 'X undefined', Y ? Y[yi] : 'Y undefined');
        
        // Show loading state
        Plotly.newPlot("lineplot", [{
            type: 'scatter',
            x: [],
            y: []
        }], {
            title: { 
                text: `Loading data for point (${X[xi]?.toFixed ? X[xi].toFixed(1) : X[xi]}, ${Y[yi]?.toFixed ? Y[yi].toFixed(1) : Y[yi]})...`,
                font: { size: 14 }
            }
        });

        // Use the non-async approach that was working before
        const valuesOverTime = [];
        const timesArray = [];
        
        let fetches = timestamps.map(ts =>
            fetch(`Frames/PM25_1/${ts}.json`)
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP error! status: ${r.status} for file: ${ts}.json`);
                    }
                    return r.json();
                })
                .then(Zraw => {
                    const value = Zraw[yi] && Zraw[yi][xi] !== undefined ? Zraw[yi][xi] : 0;
                    valuesOverTime.push(value);
                    timesArray.push(ts);
                })
                .catch(err => {
                    console.error(`Error loading ${ts}.json:`, err);
                    valuesOverTime.push(0); // Add 0 for failed requests
                    timesArray.push(ts);
                })
        );

        Promise.all(fetches).then(() => {
            console.log("Time series data loaded:", valuesOverTime.slice(0, 10));
            
            // Calculate statistics only from non-zero values
            const nonZeroValues = valuesOverTime.filter(v => v > 0);
            const maxValue = nonZeroValues.length > 0 ? Math.max(...nonZeroValues) : 100;
            const minValue = nonZeroValues.length > 0 ? Math.min(...nonZeroValues) : 0;
            const avgValue = nonZeroValues.length > 0 ? nonZeroValues.reduce((a, b) => a + b, 0) / nonZeroValues.length : 0;
            
            Plotly.newPlot("lineplot", [{
                x: timesArray,
                y: valuesOverTime,
                mode: 'lines+markers',
                line: { color: '#ED1C24', width: 2 },
                marker: { size: 4, color: '#ED1C24' },
                name: `PM2.5 at {${X[xi]}, ${Y[yi]}}`
            }], {
                title: { 
                    text: `Time Series at Point (${X[xi].toFixed(1)}, ${Y[yi].toFixed(1)})`,
                    font: { size: 14 }
                },
                xaxis: { 
                    title: "Timestamp",
                    tickangle: 45
                },
                yaxis: { 
                    title: "PM2.5 Value (µg/m³)",
                    range: [0, maxValue * 1.1]
                },
                annotations: nonZeroValues.length > 0 ? [{
                    text: `Max: ${maxValue.toFixed(1)}<br>Min: ${minValue.toFixed(1)}<br>Avg: ${avgValue.toFixed(1)}`,
                    x: 1,
                    y: 1,
                    xref: 'paper',
                    yref: 'paper',
                    showarrow: false,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#ED1C24',
                    borderwidth: 1,
                    font: { size: 11 }
                }] : [],
                margin: { t: 40, r: 80, b: 60, l: 60 }
            });
            
            console.log("Chart rendered successfully");
        })
        .catch(err => {
            console.error("Error in Promise.all:", err);
            Plotly.newPlot("lineplot", [{
                type: 'scatter',
                x: [],
                y: []
            }], {
                title: { 
                    text: `Error loading data: ${err.message}`,
                    font: { size: 14, color: 'red' }
                }
            });
        });
    }

    // Load coordinate grids
    Promise.all([
      fetch('Frames/PM25_1/xu.json').then(r => {
        if (!r.ok) throw new Error(`Failed to load xu.json: ${r.status}`);
        return r.json();
      }),
      fetch('Frames/PM25_1/yu.json').then(r => {
        if (!r.ok) throw new Error(`Failed to load yu.json: ${r.status}`);
        return r.json();
      })
    ]).then(([xu, yu]) => {
      X = xu;
      Y = yu;
      console.log("Coordinates loaded successfully. X length:", X.length, "Y length:", Y.length);

      // Generate meshgrid
      const mesh = (a, b) => {
        const x = [], y = [];
        for (let i = 0; i < b.length; i++) {
          x.push(a);
          y.push(Array(a.length).fill(b[i]));
        }
        return [x, y];
      };
      const [xmesh, ymesh] = mesh(xu, yu);

      // Function to categorize PM2.5 values
      function categorizePM25(Zraw) {
        return Zraw.map(row => row.map(val => {
            if (val === 0) return 0;              // No Data
            else if (val <= 11) return 1;                          // Good
            else if (val <= 34) return 2;                          // Moderate
            else if (val <= 54) return 3;                          // Unhealthy for Sensitive
            else if (val <= 149) return 4;                         // Unhealthy
            else if (val <= 249) return 5;                         // Very Unhealthy
            else return 6;                                         // Hazardous
        }));
      }

      // Function to update static map (no animation, just coordinate selection)
      function updateStaticMap(Z, timestamp, highlight = null, defaultColor = '#808080') {
        console.log("Updating static map for timestamp:", timestamp);
        
        const traces = [{
          type: 'heatmap',
          z: Z,
          x: X,
          y: Y,
          colorscale: [[0, defaultColor], [1, defaultColor]], // Single gray color
          zmin: 0, zmax: 6,
          showscale: false,
          zauto: false,
          connectgaps: false,
          hoverongaps: false,
          zsmooth: false,
          hoverinfo: 'x+y+z',
          hoverlabel: {bgcolor: '#FFF'},
          showgrid: true,
          gridcolor: '#808080'
        }];
        
        // Add highlighted point (e.g., default location) if provided
        if (highlight && highlight.x !== undefined && highlight.y !== undefined) {
          traces.push({
            type: 'scatter',
            x: [highlight.x],
            y: [highlight.y],
            mode: 'markers',
            marker: { color: 'red', size: 10, symbol: 'circle' },
            name: 'Selected Point',
            hoverinfo: 'x+y'
          });
        }
        
        Plotly.newPlot("staticmap", traces, {
          title: { 
            text: `Static Coordinate Selector - ${timestamp}`,
            font: { size: 14 }
          },
          xaxis: { title: 'X Coordinate', fixedrange: true },
          yaxis: { title: 'Y Coordinate', fixedrange: true },
          dragmode: false
        });
      }

      // Render a frame function - defined in main Promise scope
      function loadFrame(i) {
        if (!timestamps || timestamps.length === 0) {
          console.error("Timestamps not loaded yet");
          return;
        }
        
        const timestamp = timestamps[i];
        currentFrame = i;
        
        console.log(`Loading frame ${i + 1}/${timestamps.length}: ${timestamp}`);
        
        // Update frame counter
        const frameCounter = document.getElementById("frameCounter");
        if (frameCounter) {
          frameCounter.textContent = `${i + 1}/${timestamps.length}`;
        }
      
      fetch(`Frames/PM25_1/${timestamp}.json`)
        .then(r => r.json())
        .then(Zraw => {
            const Z = categorizePM25(Zraw);
            
            console.log("Updating 3D plot and Interactive Map for timestamp:", timestamp);
            
          // 3D plot
          Plotly.newPlot("plot3d", [{
            type: 'surface',
            x: xmesh,
            y: ymesh,
            z: Z,
            colorscale: customColor,
            cmin: 0, cmax: 6,
            showscale: false
          }], {
            title: {text: `3D Surface - ${timestamp}`},
            scene: {
              zaxis: {
                title: { text: 'AQI Category' },
                range: [0, 6]
              },
              xaxis: { title: { text: 'X Coordinate' } },
              yaxis: { title: { text: 'Y Coordinate' } },
              camera: {
                eye: { x: -1.6, y: -1.6, z: 0.8 }
              }
            }
          });

      // Common configuration for 2D views
      const common2DConfig = {
        type: 'heatmap',
        z: Z,
        x: X,
        y: Y,
        colorscale: customColor,
        zmin: 0, zmax: 6
      };

      const commonLayout = {
        xaxis: { title: '', fixedrange: true },
        yaxis: { title: '', fixedrange: true },
        dragmode: false
      };

          // Interactive map (top-right) - now with color scale
          Plotly.newPlot("map2d", [{
            ...common2DConfig,
            showscale: true,
            colorbar: {
              tickvals: [0, 1, 2, 3, 4, 5, 6],
              ticktext: [
                "0", "1 - Good (0-11)", "2 - Moderate (12-34)", "3 - Unhealthy for Sensitive (35-54)",
                "4 - Unhealthy (55-150)", "5 - Very Unhealthy (150-249)", "6 - Hazardous (>250)"
              ],
              title: {text: "AQI Category"},
            }
          }], {
            ...commonLayout,
            title: { text: `Interactive Map - ${timestamp} (Click to Select Location)`}
          });
          
          // Update static map only for the first frame (no animation)
          if (i === 0) {
            updateStaticMap(Z, timestamp, {x: X[selectedXIdx], y: Y[selectedYIdx]});
          }
        })
        .catch(err => {
          console.error("Error loading frame:", err);
        });
      }

      // Initialize empty line plot
      Plotly.newPlot("lineplot", [{
        type: 'scatter',
        x: [],
        y: []
      }], {
        title: { 
          text: 'Time Series Plot - Click on Static Coordinate Selector Map to Load Data',
          font: { size: 14 }
        },
        xaxis: { title: 'Timestamp' },
        yaxis: { title: 'PM2.5 Value (µg/m³)' },
        annotations: [{
          text: 'Click on any location in the Static Coordinate Selector Map <br>to show PM2.5 time series data for that point',
          showarrow: false,
          font: { size: 14, color: '#666' },
          xref: 'paper',
          yref: 'paper',
          x: 0.5,
          y: 0.5
        }]
      });
      
      // Initialize static coordinate selection map (bottom left)
      Plotly.newPlot("staticmap", [{
        type: 'heatmap',
        z: [[0]], // Will be updated with actual data
        x: [0],
        y: [0],
        colorscale: customColor,
        zmin: 0, zmax: 6,
        showscale: false
      }], {
        title: { 
          text: 'Static Coordinate Selector',
          font: { size: 14 }
        },
        xaxis: { title: 'X Coordinate', fixedrange: true },
        yaxis: { title: 'Y Coordinate', fixedrange: true },
        dragmode: false,
        annotations: [{
          text: 'Click to select coordinates<br>No animation - shows current frame data',
          showarrow: false,
          font: { size: 12, color: '#666' },
          xref: 'paper',
          yref: 'paper',
          x: 0.5,
          y: 0.5
        }]
      });
      
      // Load all frame file names and initialize
      console.log("Starting to fetch index.json...");
      fetch('Frames/PM25_1/index.json')
        .then(r => {
          if (!r.ok) {
            throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.json();
        })
        .then(index => {
          timestamps = index;
          slider.max = timestamps.length - 1;
          console.log("Loaded timestamps:", timestamps.length, "frames");
          console.log("Map element ready for click events");

          // Determine default selected location based on predefined coordinates
          selectedXIdx = findNearestIndex(DEFAULT_X, X);
          selectedYIdx = findNearestIndex(DEFAULT_Y, Y);
          console.log("Default location indices:", selectedXIdx, selectedYIdx, 
                      "coordinates:", X[selectedXIdx], Y[selectedYIdx]);

          // Plot default location time-series
          loadLineChart(selectedXIdx, selectedYIdx);

          loadFrame(0); // Load first frame (will also highlight default location)

          // Set up all control event handlers AFTER timestamps are loaded
          slider.addEventListener("input", () => {
            const frameIndex = parseInt(slider.value);
            console.log("Slider changed to frame:", frameIndex);
            loadFrame(frameIndex);
            currentFrame = frameIndex;
          });

          speedBtn.addEventListener("click", () => {
            isFast = !isFast;
            speed = isFast ? 2 : 5;  // 2x speed is 250ms
            speedBtn.innerText = `Speed: ${isFast ? "2x" : "1x"}`;
            console.log("Speed changed to:", isFast ? "2x" : "1x");

            // Restart animation with new speed if it's running
            if (intervalId !== null) {
              clearInterval(intervalId);
              intervalId = setInterval(() => {
                currentFrame = (currentFrame + 1) % timestamps.length;
                loadFrame(currentFrame);
                slider.value = currentFrame; // Keep slider in sync
              }, speed);
            }
          });

          startBtn.addEventListener("click", () => {
            console.log("Start button clicked, timestamps length:", timestamps.length);
            if (intervalId === null) {
              intervalId = setInterval(() => {
                currentFrame = (currentFrame + 1) % timestamps.length;
                console.log("Animation frame:", currentFrame);
                loadFrame(currentFrame);
                slider.value = currentFrame; // Update slider position
              }, speed);
            }
          });

          stopBtn.addEventListener("click", () => {
            console.log("Stop button clicked");
            clearInterval(intervalId);
            intervalId = null;
          });
          // Set up click event handler for the map (after timestamps are loaded)
          console.log("Registering click event handler for map2d");
          const mapElement = document.getElementById('map2d');
          console.log("Map element found:", mapElement);
          
          if (!mapElement) {
            console.error("ERROR: map2d element not found!");
            return;
          }
          
          mapElement.on('plotly_click', function(data) {
              console.log("Map clicked! Data:", data);
              if (data.points.length > 0) {
                  const pt = data.points[0];
                  const xval = pt.x;
                  const yval = pt.y;

                  const findNearestIndex = (val, arr) => {
                      let nearest = 0;
                      let minDiff = Math.abs(val - arr[0]);
                      for (let i = 1; i < arr.length; i++) {
                          const diff = Math.abs(val - arr[i]);
                          if (diff < minDiff) {
                              minDiff = diff;
                              nearest = i;
                          }
                      }
                      return nearest;
                  };

                  selectedXIdx = findNearestIndex(xval, X);
                  selectedYIdx = findNearestIndex(yval, Y);
                  console.log("Selected location from interactive map:", X[selectedXIdx], Y[selectedYIdx]);

                  if (selectedXIdx !== -1 && selectedYIdx !== -1) {
                      loadLineChart(selectedXIdx, selectedYIdx);
                  } else {
                      console.error("Invalid coordinates selected from interactive map:", xval, yval);
                  }
              }
          });

          // Set up click event handler for the static map (coordinate selector)
          console.log("Registering click event handler for staticmap");
          const staticMapElement = document.getElementById('staticmap');
          console.log("Static map element found:", staticMapElement);
          
          if (!staticMapElement) {
            console.error("ERROR: staticmap element not found!");
            return;
          }
          
          staticMapElement.on('plotly_click', function(data) {
              console.log("Static map clicked! Data:", data);
              if (!data || !data.points || data.points.length === 0) {
                  console.error("No valid click data received");
                  return;
              }

              const pt = data.points[0];
              if (!pt || pt.x === undefined || pt.y === undefined) {
                  console.error("Invalid point data:", pt);
                  return;
              }

              const xval = pt.x;
              const yval = pt.y;

              // Find nearest valid indices since exact matches might fail due to floating point precision
              const findNearestIndex = (val, arr) => {
                  let nearest = 0;
                  let minDiff = Math.abs(val - arr[0]);
                  for (let i = 1; i < arr.length; i++) {
                      const diff = Math.abs(val - arr[i]);
                      if (diff < minDiff) {
                          minDiff = diff;
                          nearest = i;
                      }
                  }
                  return nearest;
              };

              selectedXIdx = findNearestIndex(xval, X);
              selectedYIdx = findNearestIndex(yval, Y);
              console.log("Selected location from static map:", X[selectedXIdx], Y[selectedYIdx]);

              try {
                  loadLineChart(selectedXIdx, selectedYIdx);
                  
                  // Update static map title to show selected coordinates
                  Plotly.relayout("staticmap", {
                      title: { 
                          text: `Static Coordinate Selector - Selected Point: (${X[selectedXIdx].toFixed(1)}, ${Y[selectedYIdx].toFixed(1)})`,
                          font: { size: 14 }
                      }
                  });
              } catch (err) {
                  console.error("Error loading line chart:", err);
                  // Show error in the line plot area
                  Plotly.newPlot("lineplot", [{
                      type: 'scatter',
                      x: [],
                      y: []
                  }], {
                      title: { 
                          text: 'Error loading data. Please try another location.',
                          font: { size: 14, color: 'red' }
                      }
                  });
              }
          });
        })
        .catch(err => {
          console.error("Error loading timestamps:", err);
        });
    })
    .catch(err => {
      console.error("Error loading frame:", err);
    });

  </script>
</body>
</html>
